<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        width: 100vw;
        height: 100vh;
      }
      #buttons {
        display: flex;
        align-items: center;
        justify-content: space-around;
        width: 100%;
        padding: 20px;
      }
      .btn {
        font-size: 18px;
        font-weight: bold;
        padding: 10px 15px;
        color: white;
        background-color: dodgerblue;
        border: none;
        border-radius: 5px;
      }
      .red {
        background-color: red;
      }
      #joltage {
        font-size: 40px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 25%;
      }
      #clicks-text {
        position: absolute;
        bottom: 10px;
        left: 10px;
        font-size: 32px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="buttons"></div>
    <div id="joltage">
      <p id="joltage-text"></p>
    </div>
    <p id="clicks-text">0</p>
    <script>
      const lightsRe = /\[(.+)\]/;
      const buttonsRe = /\(([^\)]+)\)/g;
      const joltageRe = /\{(.+)\}/;

      let machine = parseMachine(
        "[#...#] (1,3) (2,3,4) (0,2,3) (0,1,2) (2,3) {37,24,60,50,16}"
      );
      let clicks = 0;

      const buttons = document.getElementById("buttons");
      const joltageText = document.getElementById("joltage-text");
      joltageText.textContent = machine.joltage.join(", ");
      const clicksText = document.getElementById("clicks-text");

      for (let button of machine.buttons) {
        btn = document.createElement("button");
        btn.textContent = button.join(", ");
        btn.onclick = () => {
          for (let idx of button) {
            machine.joltage[idx]--;
          }
          joltageText.textContent = machine.joltage.join(", ");
          calculateButtonPriority();
          clicks++;
          clicksText.textContent = clicks;
        };
        btn.classList.add("btn");
        buttons.appendChild(btn);
      }
      calculateButtonPriority();

      function calculateButtonPriority() {
        let total = machine.joltage.reduce((acc, curr) => acc + curr);
        let weights = [...machine.joltage];
        let maxWeight = 0;
        for (let i = 0; i < machine.joltage.length; i++) {
          weights[i] = Math.round((weights[i] / total) * 100);
          if (weights[i] > maxWeight) maxWeight = weights[i];
        }

        weights = weights.map((weight) => {
          let normalized = weight - Math.floor(maxWeight / 2);
          let squared = normalized ** 2;
          if (normalized < 0) squared *= -1;
          return squared;
        });

        let scores = [];
        let winner = -Infinity;
        let winnerWeight = -Infinity;
        for (let i = 0; i < machine.buttons.length; i++) {
          let weight = 0;
          for (let num of machine.buttons[i]) {
            weight += weights[num];
          }
          if (weight > winnerWeight) {
            winnerWeight = weight;
            winner = i;
          }
          scores[i] = weight;
        }
        let buttons = document.getElementsByClassName("btn");
        for (let i = 0; i < buttons.length; i++) {
          let button = buttons[i];
          button.classList.remove("red");
        }
        buttons[winner].classList.add("red");
      }

      function parseMachine(line) {
        let lights = line.match(lightsRe)[1];
        let buttons = Array.from(
          line
            .matchAll(buttonsRe)
            .map((res) => res[1].split(",").map((num) => parseInt(num)))
        );
        let joltage = line
          .match(joltageRe)[1]
          .split(",")
          .map((num) => parseInt(num));
        return { lights, buttons, joltage };
      }
    </script>
  </body>
</html>
